import React, { useEffect, useRef, useState } from "react";
import { IoIosSend } from "react-icons/io";
import userDp from "../Assets/user-dp.png";
import EmojiPicker from "emoji-picker-react";

const Message = ({ show, chat, loggedInUser, users }) => {
  const [message, setMessage] = useState("");
  const receiver = localStorage.getItem("receiver");
  const [user, setUser] = useState();
  const scrollDown = useRef();
  const [showPicker, setShowPicker] = useState(false);

  const onEmojiClick = (event) => {
    let messageTemp = message;
    messageTemp += event.emoji;
    setMessage(messageTemp);
    setShowPicker(false);
  };

  useEffect(() => {
    scrollDown.current?.scrollIntoView({ behavior: "smooth" });
  }, [chat]);

  const handleMessage = async (e) => {
    e.preventDefault();

    const req = await fetch(
      "http://localhost:5000/api/just-chat/send-message",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-access-token": localStorage.getItem("token"),
          receiver: localStorage.getItem("receiver"),
        },
        body: JSON.stringify({
          user: receiver,
          message: message,
        }),
      }
    );

    await req.json().catch((err) => console.log(err));
    setMessage("");
  };

  useEffect(() => {
    const u = users?.users.find((u) => {
      return u.email === show;
    });
    setUser(u);
  }, [show, users]);

  return (
    <>
      {show !== "" ? (
        <>
          <div className="message-box">
            <div className="show-profile">
              <div className="profile-pic">
                <img src={user?.dp || userDp} alt="dp" />{" "}
              </div>
              <div style={{ fontSize: "1.5rem", textTransform: "capitalize" }}>
                {user?.name}
              </div>
            </div>
            <div>
              {chat.map((user, index) => {
                return (
                  <div className="message" key={index} ref={scrollDown}>
                    <div
                      className={
                        user.sender === loggedInUser ? "sender" : "receiver"
                      }
                    >
                      {user?.message}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          <form
            className="message-send-form"
            onKeyDown={(e) => e.key === "Entre" && handleMessage}
            onSubmit={handleMessage}
          >
            <div className="picker-container">
              <img
                alt="Emj"
                className="emoji-icon"
                src="https://icons.getbootstrap.com/assets/icons/emoji-smile.svg"
                onClick={() => setShowPicker((val) => !val)}
              />
              {showPicker && (
                <div className="picker">
                  <EmojiPicker
                    pickerStyle={{ width: "20%" }}
                    onEmojiClick={onEmojiClick}
                    skinTonesDisabled={false}
                  />
                </div>
              )}
            </div>
            <input
              type="text"
              placeholder="Message..."
              onChange={(e) => setMessage(e.target.value)}
              value={message}
            />

            <button type="submit" className="send">
              <IoIosSend />
            </button>
          </form>
        </>
      ) : null}
    </>
  );
};

export default Message;
